# 国密算法介绍

[TOC]



#### 1、国密算法介绍
>国密算法是国家商用密码管理办公室指定的一系列的密码标准，即已经被国家密码局认定的国产密码算法，又称商用密码（是指能够实现商用密码算法的加密，解密和认证等功能的技术），保障在金融，医疗等领域的信息传输安全。



##### 1.1 国密算法概述

国密设计的初衷就是对标国际商用密码，实现自主可控，防止国际商用密码留有后门。



**比如 SM4 对标 AES 对称加密算法，SM3 对标 SHA-256 哈希算法，SM2 对标 RSA，ZUC 是序列加密/流密码。**



SM1: 一种分组密码算法,分组长度为 128 比特,密钥长度为 128 比特。(硬件,不公开)

SM2: 一种椭圆曲线公钥密码算法,其密钥长度为 256 比特 。

SM3: 一种密码杂凑（哈希）算法,其输出长度为 256 比特 。

SM4: 一种分组密码算法,分组长度为 128 比特,密钥长度为 128 比特 。

SM7: 一种分组密码算法,分组长度为 128 比特,密钥长度为 128 比特 。(硬件,不公开)

SM9: 一种基于身份标识的非对称密码算法。

ZUC: 一种序列密码算法。(祖冲之序列密码算法)



##### 1.2 加密模式

它们都是对称加密算法中的分组密码模式，用于将明文分成固定大小的块，并将每个块加密成密文。该算法的分组长度为 128bit， 即 16 字节。

- ECB 模式

  它将需要加密的消息按照块密码的块大小被分为数个块，并对每个块进行独立加密。
  ![img](https://upload.wikimedia.org/wikipedia/commons/c/c4/Ecb_encryption.png)
  ![img](https://upload.wikimedia.org/wikipedia/commons/6/66/Ecb_decryption.png)

  它的的缺点在于同样的明文块会被加密成相同的密文块。因此，它不能很好的隐藏数据模式。在某些场合，这种方法不能提供严格的数据保密性，因此并不推荐用于密码协议中。

- CBC 模式

  它将每个明文块先与前一个密文块进行异或后，再进行加密。在这种方法中，每个密文块都依赖于它前面的所有明文块。同时，为了保证每条消息的唯一性，在第一个块中需要使用初始化向量。

  ![img](https://upload.wikimedia.org/wikipedia/commons/d/d3/Cbc_encryption.png)

  ![img](https://upload.wikimedia.org/wikipedia/commons/6/66/Cbc_decryption.png)

若第一个块的下标为1，则CBC模式的加密过程为


$$
Ci=Ek(Pi⊕Ci-1)，
$$

$$
C0=IV
$$

而其解密过程则为
$$
Pi=Dk(Ci)⊕Ci-1,
$$

$$
C0=IV
$$

这里涉及的异或运算不作过多介绍，感兴趣可见 [异或运算 XOR](https://www.ruanyifeng.com/blog/2021/01/_xor.html)。



CBC 模式它的主要缺点在于加密过程是串行的，无法被并行化，而且消息必须被填充到块大小的整数倍。

注意在加密时，明文中的微小改变会导致其后的全部密文块发生改变，而在解密时，从两个邻接的密文块中即可得到一个明文块。因此，解密过程可以被并行化，而解密时，密文中一位的改变只会导致其对应的明文块完全改变和下一个明文块中对应位发生改变，不会影响到其它明文的内容。



了解以上相关加密知识后，再来看看这两种算法中使用到的填充模式，PKCS7 和补零模式：

- PKCS7

  每个填充字节的值是用于填充的字节数，即是说，若需要填充 *N* 个字节，则每个填充字节值都是 *N* 。 填充的字节数取决于算法可以处理的最小数据块的字节数量。

  ```shell
  01
  02 02
  03 03 03
  04 04 04 04
  05 05 05 05 05
  ...
  ```

  例：下例中，块大小为 8 字节，需要填充 4 字节。

  ```shell
  ... | DD DD DD DD DD DD DD DD | DD DD DD DD 04 04 04 04 |
  ```

  注意：==如果元数据刚好为数据块长度的整数倍也要在元数据后按 PKCS7 规则填充一个数据块数据，这是为了在解密时区分有效数据和补齐数据==。

  

  仍以上例，若数据大小刚好为块大小 8 字节的整数倍，则还需要填充 8 字节。

  ```shell
  ... | DD DD DD DD DD DD DD DD | 08 08 08 08 08 08 08 08 |
  ```

  

- 补零

  这个很简单，就是补零直到满足块大小。

  例：下例中，块大小为 8 字节，需要填充 4 字节。

  ```shell
  ... | DD DD DD DD DD DD DD DD | DD DD DD DD 00 00 00 00 |
  ```

